<html>
<head>
    <meta charset="UTF-8">
    <title>Unix-Magic OS - Chaos Magick Edition</title>
    <link href="https://fonts.googleapis.com/css2?family=Inconsolata&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #8a2be2;
            --text-color: #ffffff;
            --window-bg: rgba(25, 25, 25, 0.8);
        }

        body,
        html {
            margin: 0;
            padding: 0;
            height: 100%;
            font-family: 'Inconsolata', monospace;
            background: url('https://64.media.tumblr.com/c0502e4e71f5d9dc5f74da94d02e8733/49ca5cada7bd509a-50/s2048x3072/10f0268ef447985818a15631cc6a143df47f002c.gif') no-repeat center center fixed;
            background-size: cover;
            overflow: hidden;
            color: var(--text-color);
        }

        .desktop {
            width: 100%;
            height: 100%;
            position: relative;
        }

        .icon {
            width: 80px;
            height: 90px;
            position: absolute;
            text-align: center;
            cursor: pointer;
            color: #fff;
            text-shadow: 1px 1px 3px #000;
            font-size: 12px;
            transition: transform 0.3s ease;
        }

        .icon:hover {
            transform: scale(1.1);
        }

        .icon-emoji {
            font-size: 48px;
            margin-bottom: 5px;
        }

        .small-icon {
            position: fixed;
            bottom: 40px;
            right: 20px;
            width: 50px;
            height: 50px;
            background-color: rgba(138, 43, 226, 0.7);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: transform 0.3s ease;
        }

        .small-icon:hover {
            transform: scale(1.1);
        }

        .small-icon-emoji {
            font-size: 24px;
        }

        .window {
            position: absolute;
            background-color: var(--window-bg);
            border: 1px solid var(--primary-color);
            border-radius: 5px;
            box-shadow: 0 0 15px rgba(138, 43, 226, 0.5);
            overflow: hidden;
            min-width: 300px;
            min-height: 200px;
            transition: box-shadow 0.3s ease;
        }

        .window:hover {
            box-shadow: 0 0 25px rgba(138, 43, 226, 0.8);
        }

        .window-header {
            background-color: var(--primary-color);
            color: #fff;
            padding: 5px;
            cursor: move;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .window-title {
            margin: 0;
            font-size: 14px;
        }

        .window-controls span {
            margin-left: 5px;
            cursor: pointer;
            transition: color 0.3s ease;
        }

        .window-controls span:hover {
            color: #ffd700;
        }

        .window-content {
            height: calc(100% - 25px);
        }

        .window-content iframe {
            width: 100%;
            height: 100%;
            border: none;
        }

        .taskbar {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: rgba(25, 25, 25, 0.8);
            color: #fff;
            padding: 5px;
            display: flex;
            justify-content: flex-start;
            align-items: center;
        }

        .start-button {
            background-color: var(--primary-color);
            color: #fff;
            border: none;
            padding: 5px 10px;
            margin-right: 10px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .start-button:hover {
            background-color: #9932cc;
        }

        .taskbar-item {
            background-color: rgba(138, 43, 226, 0.3);
            color: #fff;
            border: none;
            padding: 5px 10px;
            margin-right: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .taskbar-item:hover {
            background-color: rgba(138, 43, 226, 0.5);
        }

        .start-menu {
            position: fixed;
            bottom: 30px;
            left: 0;
            background-color: rgba(25, 25, 25, 0.9);
            border: 1px solid var(--primary-color);
            border-radius: 5px;
            padding: 10px;
            display: none;
        }

        .start-menu a {
            display: block;
            color: var(--text-color);
            text-decoration: none;
            padding: 5px 10px;
            transition: background-color 0.3s ease;
        }

        .start-menu a:hover {
            background-color: rgba(138, 43, 226, 0.3);
        }

        .theme-selector-wrapper {
            padding: 10px;
            border-top: 1px solid var(--primary-color);
            margin-top: 10px;
        }

        .theme-selector-wrapper select {
            margin-left: 10px;
            background-color: var(--window-bg);
            color: var(--text-color);
            border: 1px solid var(--primary-color);
            padding: 2px 5px;
        }

        .customization-panel {
            padding: 20px;
            color: var(--text-color);
        }

        .customization-panel input[type="file"] {
            display: none;
        }

        .customization-panel label[for="bg-uploader"] {
            display: inline-block;
            padding: 6px 12px;
            cursor: pointer;
            background-color: var(--primary-color);
            color: var(--text-color);
            border-radius: 4px;
            margin-bottom: 10px;
        }

        .customization-panel input[type="color"] {
            margin-left: 10px;
            margin-bottom: 10px;
        }

        .update-note {
            position: absolute;
            right: 20px;
            top: 20px;
            width: 300px;
            background-color: rgba(25, 25, 25, 0.8);
            border: 1px solid var(--primary-color);
            border-radius: 5px;
            padding: 10px;
            color: #fff;
            font-size: 14px;
            box-shadow: 0 0 15px rgba(138, 43, 226, 0.5);
            transition: height 0.3s ease, opacity 0.3s ease;
            overflow: hidden;
        }

        .update-note.minimized {
            height: 30px;
            opacity: 0.7;
        }

        .update-note h3 {
            margin-top: 0;
            color: var(--primary-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .update-note .minimize-btn {
            cursor: pointer;
            font-size: 18px;
            color: #fff;
            transition: color 0.3s ease;
        }

        .update-note .minimize-btn:hover {
            color: #ffd700;
        }

        .update-note-content {
            transition: opacity 0.3s ease;
        }

        .update-note.minimized .update-note-content {
            opacity: 0;
        }

        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100%;
            font-size: 18px;
            color: #fff;
        }

        .customization-panel button {
            background-color: var(--primary-color);
            color: var(--text-color);
            border: none;
            padding: 10px 15px;
            margin-top: 10px;
            cursor: pointer;
            border-radius: 5px;
            transition: background-color 0.3s ease;
        }

        .customization-panel button:hover {
            background-color: rgba(138, 43, 226, 0.8);
        }

        /* Styles for the lock icon */
        .lock-icon {
            width: 80px;
            height: 90px;
            position: absolute;
            left: 120px;
            top: 20px;
            text-align: center;
            cursor: pointer;
            color: #fff;
            text-shadow: 1px 1px 3px #000;
            font-size: 12px;
            transition: transform 0.3s ease;
        }

        .lock-icon:hover {
            transform: scale(1.1);
        }

        .lock-icon .icon-emoji {
            font-size: 48px;
            margin-bottom: 5px;
        }

        /* Styles for notifications */
        .notification {
            position: fixed;
            bottom: 60px;
            right: 20px;
            background-color: rgba(25, 25, 25, 0.9);
            color: #fff;
            padding: 10px 15px;
            border: 1px solid var(--primary-color);
            border-radius: 5px;
            margin-bottom: 10px;
            box-shadow: 0 0 10px rgba(138, 43, 226, 0.5);
            animation: slideIn 0.5s;
            z-index: 10000;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
            }
            to {
                transform: translateX(0);
            }
        }

        /* Styles for Command App */
        .command-app-input {
            width: 80%;
            padding: 5px;
            margin-right: 5px;
            border: 1px solid var(--primary-color);
            border-radius: 3px;
            background-color: var(--window-bg);
            color: var(--text-color);
            margin-bottom: 5px;
        }

        .command-app-button {
            padding: 5px 10px;
            background-color: var(--primary-color);
            color: #fff;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            transition: background-color 0.3s ease;
            margin-bottom: 5px;
        }

        .command-app-button:hover {
            background-color: #9932cc;
        }

        .command-app-output {
            height: 200px;
            overflow-y: auto;
            background-color: #000;
            color: #0f0;
            padding: 10px;
            margin-top: 10px;
            border: 1px solid var(--primary-color);
            border-radius: 3px;
        }

        /* Styles for the tabs in Command App */
        .command-app-tabs {
            display: flex;
            border-bottom: 1px solid var(--primary-color);
            margin-bottom: 10px;
        }

        .command-app-tab {
            padding: 10px 20px;
            cursor: pointer;
            background-color: var(--window-bg);
            color: var(--text-color);
            border: 1px solid var(--primary-color);
            border-bottom: none;
            border-radius: 5px 5px 0 0;
            margin-right: 5px;
        }

        .command-app-tab.active {
            background-color: var(--primary-color);
        }

        .command-app-tab-content {
            display: none;
        }

        .command-app-tab-content.active {
            display: block;
        }

    </style>
    <script>
        let zIndex = 1000;
        const openWindows = new Set();
        let hackingEnabled = false;
        const consoleCommands = [];
        const allowedCommands = {}; // Store custom command functionalities

        function showNotification(message) {
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.innerHTML = `
                <strong>News:</strong> ${message}
            `;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.style.opacity = '0';
                setTimeout(() => {
                    notification.remove();
                }, 500);
            }, 5000);
        }

        function generateNewsFromConsole() {
            if (consoleCommands.length > 0) {
                const lastCommand = consoleCommands[consoleCommands.length - 1];
                const message = `User executed command: ${lastCommand}`;
                showNotification(message);
            }
        }

        async function getAIResponse(commandInput, functionalityDescription = '') {
            try {
                let promptText = `
Simulate the execution of the following command in a Unix-like terminal.
`;

                if (functionalityDescription) {
                    promptText += `
The command is a custom command defined to perform the following function:
${functionalityDescription}
`;
                }

                promptText += `
Command:
${commandInput}

Output:
`;

                const response = await fetch('/api/ai_completion', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json',
                    },
                    body: JSON.stringify({
                        prompt: promptText,
                        data: ''
                    }),
                });
                const data = await response.text();
                return data;
            } catch (error) {
                console.error('Error fetching AI response:', error);
                return 'Error occurred';
            }
        }

        function createCommandAppContent() {
            const contentDiv = document.createElement('div');
            contentDiv.style.padding = '10px';

            const tabs = document.createElement('div');
            tabs.className = 'command-app-tabs';

            const tab1 = document.createElement('div');
            tab1.className = 'command-app-tab active';
            tab1.textContent = 'Test Commands';

            const tab2 = document.createElement('div');
            tab2.className = 'command-app-tab';
            tab2.textContent = 'Make Commands';

            tabs.appendChild(tab1);
            tabs.appendChild(tab2);

            const tabContent1 = document.createElement('div');
            tabContent1.className = 'command-app-tab-content active';

            const tabContent2 = document.createElement('div');
            tabContent2.className = 'command-app-tab-content';

            // Contents for Test Commands tab (tabContent1)
            const input = document.createElement('input');
            input.type = 'text';
            input.className = 'command-app-input';

            const button = document.createElement('button');
            button.textContent = 'Execute';
            button.className = 'command-app-button';

            const output = document.createElement('pre');
            output.className = 'command-app-output';

            button.onclick = async () => {
                const command = input.value.trim();
                if (command === '') {
                    return;
                }

                let functionalityDescription = allowedCommands[command];

                // Send the command to the AI and get the response
                const response = await getAIResponse(command, functionalityDescription);
                output.textContent += `\n> ${command}\n${response}`;
                input.value = '';

                // Store the command for news generation
                consoleCommands.push(command);
                generateNewsFromConsole();
            };

            tabContent1.appendChild(input);
            tabContent1.appendChild(button);
            tabContent1.appendChild(output);

            // Contents for Make Commands tab (tabContent2)
            const commandInput = document.createElement('input');
            commandInput.type = 'text';
            commandInput.placeholder = 'Command Name';
            commandInput.className = 'command-app-input';

            const responseInput = document.createElement('input');
            responseInput.type = 'text';
            responseInput.placeholder = 'Command Functionality';
            responseInput.className = 'command-app-input';

            const addButton = document.createElement('button');
            addButton.textContent = 'Add Command';
            addButton.className = 'command-app-button';

            addButton.onclick = () => {
                const cmdName = commandInput.value.trim();
                const cmdFunctionality = responseInput.value.trim();

                if (cmdName === '' || cmdFunctionality === '') {
                    return;
                }

                allowedCommands[cmdName] = cmdFunctionality;
                output.textContent += `\nNew command added: ${cmdName}`;
                commandInput.value = '';
                responseInput.value = '';
            };

            tabContent2.appendChild(commandInput);
            tabContent2.appendChild(responseInput);
            tabContent2.appendChild(addButton);

            contentDiv.appendChild(tabs);
            contentDiv.appendChild(tabContent1);
            contentDiv.appendChild(tabContent2);

            // Tab switching functionality
            tab1.onclick = () => {
                tab1.classList.add('active');
                tab2.classList.remove('active');
                tabContent1.classList.add('active');
                tabContent2.classList.remove('active');
            };

            tab2.onclick = () => {
                tab2.classList.add('active');
                tab1.classList.remove('active');
                tabContent2.classList.add('active');
                tabContent1.classList.remove('active');
            };

            return contentDiv;
        }

        const openWindow = (name, url, contentFunction = null) => {
            const windowElement = document.createElement('div');
            windowElement.className = 'window';
            windowElement.style.cssText = `
                width: 600px;
                height: 400px;
                left: 10%;
                top: 10%;
                z-index: ${++zIndex};
            `;

            windowElement.innerHTML = `
                <div class="window-header">
                    <h3 class="window-title">${name}</h3>
                    <div class="window-controls">
                        <span class="minimize">_</span>
                        <span class="maximize">â–¡</span>
                        <span class="close">Ã—</span>
                    </div>
                </div>
                <div class="window-content">
                    <div class="loading">Loading...</div>
                </div>
            `;

            const desktop = document.querySelector('.desktop');
            desktop.appendChild(windowElement);
            makeDraggable(windowElement);

            const closeBtn = windowElement.querySelector('.close');
            closeBtn.onclick = () => {
                desktop.removeChild(windowElement);
                openWindows.delete(name);
                updateTaskbar();
            };

            const maximizeBtn = windowElement.querySelector('.maximize');
            maximizeBtn.onclick = () => {
                const isMaximized = windowElement.style.width === '100%';
                windowElement.style.cssText = isMaximized ? `
                    width: 600px;
                    height: 400px;
                    left: 10%;
                    top: 10%;
                    z-index: ${++zIndex};
                ` : `
                    width: 100%;
                    height: calc(100% - 30px);
                    left: 0;
                    top: 0;
                    z-index: ${++zIndex};
                `;
            };

            windowElement.addEventListener('mousedown', () => windowElement.style.zIndex = ++zIndex);

            openWindows.add(name);
            updateTaskbar();

            if (contentFunction) {
                const content = contentFunction();
                windowElement.querySelector('.window-content').innerHTML = '';
                windowElement.querySelector('.window-content').appendChild(content);
            } else if (url) {
                setTimeout(() => {
                    const windowContent = windowElement.querySelector('.window-content');
                    let iframeUrl = url;
                    if (name === 'Terminal' && hackingEnabled) {
                        iframeUrl += '?hacking=true';
                    }
                    const iframe = document.createElement('iframe');
                    iframe.src = iframeUrl;
                    iframe.sandbox = 'allow-scripts allow-same-origin';
                    iframe.allow = 'geolocation; microphone; camera';
                    iframe.allowFullscreen = true;
                    iframe.style.width = '100%';
                    iframe.style.height = '100%';
                    windowContent.innerHTML = '';
                    windowContent.appendChild(iframe);

                    window.addEventListener('message', (event) => {
                        if (event.source === iframe.contentWindow && event.data.type === 'consoleCommand') {
                            const command = event.data.command;
                            consoleCommands.push(command);
                            generateNewsFromConsole();
                        }
                    });
                }, 100);
            }
        };

        function makeDraggable(element) {
            let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
            element.querySelector('.window-header').onmousedown = dragMouseDown;

            function dragMouseDown(e) {
                e = e || window.event;
                e.preventDefault();
                pos3 = e.clientX;
                pos4 = e.clientY;
                document.onmouseup = closeDragElement;
                document.onmousemove = elementDrag;
            }

            function elementDrag(e) {
                e = e || window.event;
                e.preventDefault();
                pos1 = pos3 - e.clientX;
                pos2 = pos4 - e.clientY;
                pos3 = e.clientX;
                pos4 = e.clientY;
                element.style.top = (element.offsetTop - pos2) + "px";
                element.style.left = (element.offsetLeft - pos1) + "px";
            }

            function closeDragElement() {
                document.onmouseup = null;
                document.onmousemove = null;
            }
        }

        const openWindowFromMenu = (name) => {
            const app = window.apps[name];
            openWindow(name, app.url, app.content);
        };

        const createIcon = (name, app) => {
            const { icon: emoji, x, y } = app;
            const icon = document.createElement('div');
            icon.className = 'icon';
            icon.style.cssText = `left: ${x}px; top: ${y}px;`;
            icon.innerHTML = `
                <div class="icon-emoji">${emoji}</div>
                <div>${name}</div>
            `;
            icon.onclick = () => openWindow(name, app.url, app.content);
            document.querySelector('.desktop').appendChild(icon);
        };

        const createTaskbar = () => {
            const taskbar = document.createElement('div');
            taskbar.className = 'taskbar';
            document.body.appendChild(taskbar);
            return taskbar;
        };

        const updateTaskbar = () => {
            let taskbar = document.querySelector('.taskbar');
            if (!taskbar) {
                taskbar = createTaskbar();
            }
            taskbar.innerHTML = '<button class="start-button">Start</button>';
            openWindows.forEach(windowName => {
                const taskbarItem = document.createElement('button');
                taskbarItem.className = 'taskbar-item';
                taskbarItem.textContent = windowName;
                taskbarItem.onclick = () => {
                    const windows = document.querySelectorAll('.window');
                    windows.forEach(win => {
                        const title = win.querySelector('.window-title').textContent;
                        if (title === windowName) {
                            win.style.zIndex = ++zIndex;
                        }
                    });
                };
                taskbar.appendChild(taskbarItem);
            });

            taskbar.querySelector('.start-button').onclick = toggleStartMenu;
        };

        const toggleStartMenu = () => {
            const startMenu = document.querySelector('.start-menu');
            startMenu.style.display = startMenu.style.display === 'none' ? 'block' : 'none';
        };

        const createLockIcon = () => {
            const lockIcon = document.createElement('div');
            lockIcon.className = 'lock-icon';
            lockIcon.innerHTML = `
                <div class="icon-emoji">ðŸ”’</div>
                <div>Security</div>
            `;
            let locked = true;
            lockIcon.onclick = () => {
                locked = !locked;
                lockIcon.querySelector('.icon-emoji').textContent = locked ? 'ðŸ”’' : 'ðŸ”“';
                hackingEnabled = !locked;
            };
            document.querySelector('.desktop').appendChild(lockIcon);
        };

        window.onload = () => {
            window.apps = {
                'Tarot Reader': { icon: 'ðŸƒ', x: 20, y: 20, url: 'https://websim.ai/@input_source/tarotreader', content: null },
                'Sigil Forge': { icon: 'â›§', x: 20, y: 130, url: 'https://websim.ai/@input_source/advanced-purple-sigil-forge-unix-magic-os', content: null },
                'Terminal': { icon: 'ðŸ’»', x: 20, y: 240, url: 'https://websim.ai/@input_source/chaosmagick-terminal-unixmagick-os-1', content: null },
                'Astral Projection': { icon: 'ðŸ§˜', x: 20, y: 350, url: 'https://websim.ai/@input_source/astral-projection-guide-unix-magic-os', content: null },
                'Alchemical Lab': { icon: 'âš—ï¸', x: 20, y: 460, url: 'https://websim.ai/@input_source/alchemical-lab-unix-magic-os-responsive', content: null },
                'Magick Search': { icon: 'ðŸ”®', x: 20, y: 570, url: 'https://websim.ai/@input_source/magicksearch', content: null },
                'Command App': { icon: 'ðŸ’¬', x: 120, y: 130, url: null, content: createCommandAppContent },
            };

            Object.entries(window.apps).forEach(([name, app]) => {
                createIcon(name, app);
            });

            createLockIcon();

            const startMenu = document.createElement('div');
            startMenu.className = 'start-menu';
            startMenu.innerHTML = Object.keys(window.apps).map(name =>
                `<a href="#" onclick="openWindowFromMenu('${name}')">${name}</a>`
            ).join('');

            startMenu.style.display = 'none';
            document.body.appendChild(startMenu);

            updateTaskbar();
        };

        document.addEventListener('click', (e) => {
            if (!e.target.closest('.start-button') && !e.target.closest('.start-menu')) {
                document.querySelector('.start-menu').style.display = 'none';
            }
        });
    </script>
</head>
<body>
    <div class="desktop"></div>
</body>
</html>